<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Realtime Speech â†’ StableBuffer â†’ LLM</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>ðŸŽ¤ Realtime Speech â†’ StableBuffer â†’ LLM</h2>
    <button id="startBtn">Start Mic</button>
    <button id="stopBtn">Stop</button>

    <p><b>Partial:</b> <span id="partial"></span></p>
    <p><b>Final:</b> <span id="final"></span></p>
    <p><b>LLM:</b> <span id="llm"></span></p>

<script>
let ws = null;
let audioContext = null;
let workletNode = null;

document.getElementById("startBtn").onclick = async () => {
    console.log("ðŸ”Š Starting Worklet microphone stream...");

    // -----------------------
    // 1. OPEN WEBSOCKET
    // -----------------------
    ws = new WebSocket("ws://localhost:8000/ws/stream");
    ws.binaryType = "arraybuffer";

    ws.onopen = () => console.log("WS connected");
    ws.onclose = () => console.log("WS closed");

    ws.onmessage = (msg) => {
        const d = JSON.parse(msg.data);
        if (d.type === "partial") document.getElementById("partial").textContent = d.text;
        if (d.type === "final") document.getElementById("final").textContent = d.text;
        if (d.type === "llm") document.getElementById("llm").textContent = d.content;
    };

    // -----------------------
    // 2. CAPTURE MIC STREAM
    // -----------------------
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    audioContext = new AudioContext({
        sampleRate: 16000   // REQUIRED for Azure STT
    });

    // -----------------------
    // 3. LOAD AUDIO WORKLET
    // -----------------------
    await audioContext.audioWorklet.addModule("/static/pcm-worklet.js");

    const source = audioContext.createMediaStreamSource(stream);

    // Create WorkletNode
    workletNode = new AudioWorkletNode(audioContext, "pcm-processor");

    // Receive Int16 PCM data from worklet and push to server
    workletNode.port.onmessage = (event) => {
        const pcmBytes = event.data;    
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(pcmBytes);
        }
    };

    // Start pipeline
    source.connect(workletNode);

    console.log("ðŸŽ¤ Worklet + WS streaming ACTIVE");
};

document.getElementById("stopBtn").onclick = () => {
    console.log("ðŸ›‘ STOP STREAM");

    try { if (workletNode) workletNode.disconnect(); } catch {}
    try { if (audioContext) audioContext.close(); } catch {}
    try { if (ws) ws.close(); } catch {}

    console.log("ðŸ›‘ Mic + WS stopped");
};
</script>

</body>
</html>
